!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.tokenValidatorPlugin=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function _appendCredentialsAndButton(domObject){credentialsData&&domObject&&(domObject.html('<span class="hljs-tag"><strong>ClientId:</strong></span> '+credentialsData.clientId+'<br><span class="hljs-tag"><strong>ClientSecret:</strong></span> '+credentialsData.clientSecret+'<br><span class="hljs-tag"><strong>ClientName:</strong></span> '+credentialsData.appId+'<br><span class="hljs-tag"><strong>ProjectId:</strong></span> '+credentialsData.projectId+'<br><span class="hljs-tag"><strong>Token:</strong></span> '+credentialsData.token),domObject.next(".js-show-hide").text(credentialsData.buttonText))}function _initializeCredentialsData(initial,data){initial?credentialsData={appId:data.appId,clientId:MASKED_VALUES,clientSecret:MASKED_VALUES,projectId:data.projectId,token:data.token,buttonText:"show"}:"show"===credentialsData.buttonText?(credentialsData.clientId=data.clientId,credentialsData.clientSecret=data.clientSecret,credentialsData.buttonText="hide"):(credentialsData.clientId=MASKED_VALUES,credentialsData.clientSecret=MASKED_VALUES,credentialsData.buttonText="show")}function setCredentials(data,domObject,initial){data&&(_initializeCredentialsData(initial,data),_appendCredentialsAndButton(domObject))}var MASKED_VALUES="********",credentialsData={};module.exports={setCredentials:setCredentials}},{}],2:[function(require,module,exports){var credentialsHandler=require("./credentialsFunctions");module.exports=function(){"use strict";function init(){IDTOKEN=lscache.get("id_token");var loginFrameUrl=OAUTH_SERVICE_URL+"/authorize?response_type=id_token token&client_id="+CLIENT_ID+"&nonce="+Math.ceil(100*Math.random())+"&display=popup&redirect_uri="+REDIR_URL+"&scope=hybris.no_tenant&hybris_stylesheet_url="+LOGIN_CSS_URL;if(!IDTOKEN)return $("#loginFrame").attr("src",loginFrameUrl),$("#loginHandlerWrapper").removeClass("u-hide-permanently");$("#loginHandlerWrapper").addClass("u-hide-permanently"),CLAIM=getClaim(IDTOKEN);const expirationDate=1e3*CLAIM.exp;return new Date(expirationDate).getTime()<(new Date).getTime()?($("#loginFrame").attr("src",loginFrameUrl),lscache.remove("id_token"),$("#loginHandlerWrapper").removeClass("u-hide-permanently")):(lscache.get("login")||lscache.set("login",CLAIM.email),newProjectResilience(checkNoTenantToken),void $("#apiNotebookHandler").on("click",function(){$(".alert-danger").remove(),lscache.get("noTenantToken")?getCredentials():authorize()}))}function getClaim(idToken){var tokenClaim=idToken.split(".")[1],uClaim=b64utos(tokenClaim);return JWS.readSafeJSONString(uClaim)}function getCredentials(){var userToken=lscache.get("noTenantToken");CLAIM=getClaim(IDTOKEN);var scopesQueryParam=createScopeQueryParam();lscache.set("login",CLAIM.email),$("#newProjectLoader").fadeIn(300),$.ajax({url:YODA_SERVICE_URL+"/application"+scopesQueryParam,method:"POST",headers:{Authorization:"Bearer "+userToken}}).done(function(data,xhr,result){function showHideCredentials(){credentialsHandler.setCredentials(data,$("#credentials code"),!1)}201===result.status&&($("#newProjectLoader").fadeOut(300),$("#newProject .grid-cards__title").html("New Project setup succesfully"),$("#newProject .grid-cards__description").hide(),credentialsHandler.setCredentials(data,$("#credentials code"),!0),$("#credentials").slideDown(300),$("#apiNotebookInjecter").slideDown(300),$("#newProjectHeader").after('<div style="display:none;" class="alert alert-success alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>Generated project will last only for 1h and will be permanently deleted after that time.</div>').next().slideDown(300,sendMessageResizeNeeded),$("#apiNotebookInjecter").on("click",function(){try{window.sessionStorage.setItem("credentials",JSON.stringify(data)),$("#iframeNotebook").contents().find("#credentialsButton").trigger("click"),sendMessageResizeNeeded()}catch(err){}}),$("#showHideCredentialsNew").click(showHideCredentials),$("#apiNotebookHandler").hide())}).fail(function(){$("#newProjectLoader").fadeOut(300),showErrorNewProjectHeader("Project setup was not possible, please try again.")})}function authorize(){var authFrame=document.createElement("iframe");authFrame.setAttribute("id","oauthFrame"),authFrame.setAttribute("style","display: none;position:absolute; top:0px; left:0px;"),document.body.appendChild(authFrame),authFrame.src=OAUTH_SERVICE_URL+"/authorize?response_type=token&client_id="+CLIENT_ID+"&redirect_uri="+REDIR_URL+"&id_token_hint="+lscache.get("id_token")+"&scope=hybris.no_tenant",authFrame.addEventListener("load",function(){var hash,frameContent,frame=document.getElementById("oauthFrame");try{frameContent=frame.contentDocument,hash=frameContent.location.hash,hash||window.parent.postMessage({failed:!0},"*")}catch(e){onGetTokenError()}},!1)}function onGetTokenError(){$("#newProjectLoader").fadeOut(300),showErrorNewProjectHeader("Your access token expired and we failed to renew it, please try again.")}function showErrorNewProjectHeader(msg){$("#newProjectHeader").after('<div style="display:none;" class="alert alert-danger alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+msg+"</div>").next().slideDown(300)}function sendMessageResizeNeeded(){var event=new CustomEvent("resizeNeeded");window.dispatchEvent(event)}function newProjectResilience(callback){$.ajax({url:YODA_SERVICE_URL+"/checkup",method:"GET"}).done(function(data,xhr,result){200===result.status&&callback()})}function checkNoTenantToken(){lscache.get("noTenantToken")?$("#newProject").removeClass("u-hide-permanently"):authorize()}function createScopeQueryParam(){var scopes=window.scopes;return scopes?"?scopes="+scopes:""}function receiveMessage(event){var data=event.data;if(data&&data.idToken){$("#loginModal").modal("hide");var frames=window.parent&&window.parent.$(".apinotebookFrame");frames&&frames.length?frames.each(function(){this.contentWindow.initApp(),this.contentWindow.initToken()}):(initApp(),initToken())}data&&data.failed&&onGetTokenError(),data&&data.noTenantToken&&($("#oauthFrame").remove(),newProjectResilience(checkNoTenantToken))}var PLUGIN=({proxy:{proxyUrl:"/proxy"},envVariables:{yodaLink:"https://api.beta.yaas.io/hybris/yoda/v1",oauthService:"https://api.beta.yaas.io/hybris/oauth2/v1",accountService:"https://api.beta.yaas.io/hybris/account/v1/",APIManangementService:"https://api.beta.yaas.io/hybris/api-management/v1/",packageService:"https://api.beta.yaas.io/hybris/package/v1",clientId:"AhvOOZ7fLGgJu2PUZCOFTLsum0DqFCQH",redirUrl:"http://127.0.0.1:9778/auth.html",loginCssUrl:"https://devportal.yaas.io/styles/auth-iframe.css"},customLocation:{path:"./apinotebooks",mode:"external"}}||{}).envVariables;if(PLUGIN){var CLAIM,IDTOKEN,TO_REPLACE_REDIR_URL=PLUGIN.redirUrl,YODA_SERVICE_URL=PLUGIN.yodaLink,OAUTH_SERVICE_URL=PLUGIN.oauthService,CLIENT_ID=PLUGIN.clientId,REDIR_URL=TO_REPLACE_REDIR_URL,LOGIN_CSS_URL=PLUGIN.loginCssUrl,JWS=KJUR.jws.JWS;$("#apiNotebookHandler").ready(init),window.addEventListener("message",receiveMessage,!1),window.initToken=init}}},{"./credentialsFunctions":1}]},{},[2])(2)});